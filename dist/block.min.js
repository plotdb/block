(function(){function import$(e,t){var n={}.hasOwnProperty;for(var i in t)n.call(t,i)&&(e[i]=t[i]);return e}var win,doc,rescope,csscope,proxise,fetch,e404,_fetch,rid,parseNameString,sanitize,pubsub,block,slice$=[].slice;rescope="undefined"!=typeof window&&null!==window?window.rescope:"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require?require("@plotdb/rescope/dist/v4"):null,csscope="undefined"!=typeof window&&null!==window?window.csscope:"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require?require("@plotdb/csscope"):null,proxise="undefined"!=typeof window&&null!==window?window.proxise:"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require?require("proxise"):null,fetch="undefined"!=typeof window&&null!==window?window.fetch:"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require?require("node-fetch"):null,e404=function(){var e;return Promise.reject((e=new Error,e.name="lderror",e.id=404,e))},_fetch=function(e,t){return fetch(e,t).then(function(e){var t;return e&&e.ok?e.text():e?e.clone().text().then(function(t){var n,i,r,o;n=e.status||404,(r=new Error(n+" "+t)).name="lderror",r.id=n,r.message=t,i=r;try{(o=JSON.parse(t))&&"lderror"===o.name&&(import$(i,o).json=o)}catch(e){e}return Promise.reject(i)}):Promise.reject((t=new Error("404"),t.name="lderror",t.id=404,t))})},rid=function(){for(var e;e="b-"+Math.random().toString(36).substring(2),rid.hash[e];);return rid.hash[e]=!0,e},rid.hash={},parseNameString=function(e){var t,n;return e=e.split("@"),t=e[0]?[e[0],e[1]]:["@"+e[1],e[2]],e=t[0],n=t[1],{name:e,version:n}},sanitize=function(e){return e||""},pubsub=function(){return this.subs={},this},pubsub.prototype=import$(Object.create(Object.prototype),{fire:function(e){var t,n,i,r,o;for(n=[],i=1,r=arguments.length;i<r;++i)n.push(arguments[i]);return t=n,Promise.all(((o=this.subs)[e]||(o[e]=[])).map(function(e){return e.apply(null,t)}))},on:function(e,t){var n;return((n=this.subs)[e]||(n[e]=[])).push(t)}}),block={},block.env=function(e){var t;return t=[e,e.document],win=t[0],doc=t[1],rescope.env(win),csscope.env(win)},block.i18n={module:{lng:"en",t:function(e){var t,n,i,r,o,s,c,l,u,a;for(t=Array.isArray(e)?e:[e],n=this.lng,i=0,r=t.length;i<r;++i)if(o=i,t[o]&&(s=t[o].split(":"),c=s[0],l=slice$.call(s,1),l=l.join(":"),u=((s=(a=this.res)[n]||(a[n]={}))[c]||(s[c]={}))[l]))return u;return l||c||e[e.length-1]},changeLanguage:function(e){return this.lng=e||"en"},addResourceBundle:function(e,t,n,i,r){var o;return((o=this.res)[e]||(o[e]={}))[t]=n},res:{}},use:function(e){return this.module=e},addResourceBundle:function(e,t,n,i,r){return null==i&&(i=!0),null==r&&(r=!0),block.i18n.module.addResourceBundle(e,t,n,i,r)}},block.global={csscope:{hash:{},apply:function(e){var t=this;if((e=e.filter(function(e){return!t.hash[e.url]}).map(function(e){return t.hash[e.url]=e.scope})).length)return doc.body.classList.add.apply(doc.body.classList,e)}}},block.init=proxise.once(function(){if(block._rescope)return block._rescope.init()}),block.rescope=function(){return block._rescope||(block._rescope=new rescope({global:null!=win?win:global})),block._rescope},block.csscope=function(){return block._csscope||(block._csscope=new csscope.manager),block._csscope},block.manager=function(e){var t=this;return null==e&&(e={}),this.hash={},this.proxy={},this.running={},this._chain=e.chain||null,this._fetch=e.fetch||null,this.init=proxise.once(function(){return t._init()}),this.rescope=e.rescope instanceof rescope?e.rescope:block.rescope(),this.csscope=e.csscope instanceof csscope?e.csscope:block.csscope(),e.registry&&this.registry(e.registry),this.init(),this},block.manager.prototype=import$(Object.create(Object.prototype),{_init:function(){return this.rescope===block.rescope()?block.init():this.rescope.init()},chain:function(e){return this._chain=e},registry:function(e){var t;if("string"!=(t=typeof e)&&"function"!==t||(e={lib:e,block:e}),null!=e.lib&&(this.rescope===block.rescope()&&(this.rescope=new rescope({global:win})),this.csscope===block.csscope()&&(this.csscope=new csscope.manager),this.rescope.registry(e.lib),this.csscope.registry(e.lib)),null!=e.block&&(this._reg=e.block||"","string"==typeof this._reg&&this._reg&&"/"!==(t=this._reg)[t.length-1]))return this._reg+="/"},set:function(e){var t,n=this;return null==e&&(e={}),t=Array.isArray(e)?e:[e],Promise.all(t.map(function(e){var t,i,r,o,s,c;return t=e.name,i=e.version,r=e.path,o=e instanceof block.class?e:e.block,((s=(c=n.hash)[t]||(c[t]={}))[i]||(s[i]={}))[r||"index.html"]=o}))},getUrl:function(e){var t,n,i;return t=e.name,n=e.version,i=e.path,"function"==typeof this._reg?this._reg({name:t,version:n,path:i,type:"block"}):(this._reg||"")+"/assets/block/"+t+"/"+(n||"main")+"/"+(i||"index.html")},fetch:function(e){var t;return this._fetch?Promise.resolve(this._fetch(e)):(t=this.getUrl({name:e.name,version:e.version,path:e.path}))?_fetch(t,{method:"GET"}):e404()},_get:function(e){var t,n,i,r,o,s=this;return t=[e.name,e.version||"main",e.path||"index.html"],n=t[0],i=t[1],r=t[2],n&&i?null==((t=(o=this.hash)[n]||(o[n]={}))[i]||(t[i]={}))[r]||e.force?!0!==((t=(o=this.running)[n]||(o[n]={}))[i]||(t[i]={}))[r]?(this.running[n][i][r]=!0,this.fetch({name:e.name,version:e.version,path:e.path}).then(function(e){return e||e404()}).catch(function(t){return s._chain?s._chain.get(e):Promise.reject(t)}).then(function(e){var t,o;return null==e&&(e={}),t=new block.class({code:e,name:n,version:i,path:r,manager:s}),s.set(o={name:n,version:i,path:r,block:t}),e.version&&e.version!==i&&s.set((o.version=e.version,o)),t}).then(function(e){return s.proxy[n][i][r].resolve(e),e}).finally(function(){return s.running[n][i][r]=!1}).catch(function(e){return s.proxy[n][i][r].reject(e),Promise.reject(e)})):void 0:Promise.resolve(this.hash[n][i][r]):Promise.reject((t=new Error,t.name="lderror",t.id=1015,t))},get:function(e){var t,n=this;return null==e&&(e={}),t=Array.isArray(e)?e:[e],Promise.all(t.map(function(e){var t,i,r,o,s;return null==e&&(e={}),"string"==typeof e&&(e=parseNameString(e)),t=[e.name,e.version||"main",e.path||"index.html"],i=t[0],r=t[1],o=t[2],((t=(s=n.proxy)[i]||(s[i]={}))[r]||(t[r]={}))[o]||(n.proxy[i][r][o]=proxise(function(e){return n._get(e)})),n.proxy[i][r][o](e)})).then(function(t){return Array.isArray(e)?t:t[0]})}}),block.class=function(e){var t,n,i,r,o,s,c,l=this;if(null==e&&(e={}),this.opt=e,this.scope=e.scope||null,this._ctx={},this.csscopes={global:[],local:[]},this.name=e.name,this.version=e.version,this.path=e.path,this.manager=e.manager,this.manager||console.warn("manager is mandatory when constructing block.class"),t=e.code,e.root?n="string"==typeof e.root?doc.querySelector(e.root):e.root:("function"==typeof t&&(t=t()),"string"==typeof t?(t=sanitize(t),(i=doc.createElement("div")).innerHTML=(t||"").trim(),i.childNodes.length>1&&console.warn("DOM definition of a block should contain only one root.")):"object"==typeof t&&(this.script=t.script,this.style=t.style,this.style=t.style,this.script=t.script,(r=t.dom instanceof Function?t.dom():t.dom)instanceof win.Element?n=r:(t=sanitize(r),(i=doc.createElement("div")).innerHTML=t,i.childNodes.length>1&&console.warn("DOM definition of a block should contain only one root.")))),["script","style","link"].map(function(e){var t;return t=Array.from((n||i).querySelectorAll(e)).map(function(e){return e.parentNode.removeChild(e),e.textContent}).join("\n"),l[e]=null!=t&&t?t:l[e]||""}),!n&&i)for(o=0,s=i.childNodes.length;o<s&&(c=o,(n=i.childNodes[c]).nodeType!==win.Element.ELEMENT_NODE);++o);return n||(n=doc.createElement("div")),n.nodeType!==win.Element.ELEMENT_NODE&&console.log(warn("root of DOM definition of a block should be an Element")),this.node=n,this.init=proxise.once(function(){return l._init()}),this},block.class.prototype=import$(Object.create(Object.prototype),{_init:function(){var this$=this;return block.init().then(function(){var v,ref$,ret;return this$.interface=this$.script instanceof Function?this$.script():"object"==typeof this$.script?this$.script:(v=eval(this$.script||""))instanceof Function?v():v||{},this$.interface||(this$.interface={}),(ref$=this$.interface).pkg||(ref$.pkg={}),this$.name||(this$.name=this$.interface.pkg.name),this$.version||(this$.version=this$.interface.pkg.version),this$.path||(this$.path=this$.interface.pkg.path),this$.id=(this$.name||rid())+"@"+(this$.version||rid())+"/"+(this$.path||"index.html"),this$.scope||(this$.scope="_"+btoa(this$.id).replace(/=/g,"_")),this$.style&&(doc.body.appendChild(this$.styleNode=doc.createElement("style")),this$.styleNode.setAttribute("type","text/css"),this$.styleNode.textContent=ret=csscope({rule:"*[scope~="+this$.scope+"]",name:this$.scope,css:this$.style,scopeTest:"[scope]"})),this$.factory=function(){var e,t,n;for(e=[],t=0,n=arguments.length;t<n;++t)e.push(arguments[t]);return e,this},this$.factory.prototype=import$((ref$=Object.create(Object.prototype),ref$.init=function(){},ref$.destroy=function(){},ref$),this$.interface)}).then(function(){if(this$.extends=[],this$.interface.pkg.extend)return this$.manager?this$.manager.get(this$.interface.pkg.extend).then(function(e){return this$.extend=e,this$.extendDom=!(null!=this$.interface.pkg.extend.dom)||this$.interface.pkg.extend.dom,this$.extendStyle=!(null!=this$.interface.pkg.extend.style)||this$.interface.pkg.extend.style,this$.extend.init()}).then(function(){return this$.extends=[this$.extend].concat(this$.extend.extends)}):new Error("no available manager to get extended block")}).then(function(){var e,t,n,i=[];e=this$.interface.pkg.i18n||{};for(t in e)n=e[t],i.push(block.i18n.module.addResourceBundle(t,this$.id,n,!0,!0));return i}).then(function(){var e,t;return this$.dependencies=Array.isArray(this$.interface.pkg.dependencies)?this$.interface.pkg.dependencies:function(){var n,i=[];for(e in n=this.interface.pkg.dependencies||{})t=n[e],i.push(t);return i}.call(this$),this$.dependencies.map(function(e){if(!e.type)return/\.js$/.exec(e.url||e.path||e)?e.type="js":/\.css$/.exec(e.url||e.path||e)?e.type="css":e.type="js"}),this$.extend?this$._ctx=this$.extend.context():rescope.proxin&&(this$._ctx=new rescope.proxin),this$.manager.rescope.load(this$.dependencies.filter(function(e){return!e.type||"js"===e.type}),this$._ctx)}).then(function(){return this$.manager.csscope.load(this$.dependencies.filter(function(e){return"css"===e.type&&!0===e.global}).map(function(e){return e.url||e}))}).then(function(e){return this$.csscopes.global=e||[],this$.manager.csscope.load(this$.dependencies.filter(function(e){return"css"===e.type&&!0!==e.global}).map(function(e){return e.url||e}))}).then(function(e){var t;if(this$.csscopes.local=e||[],this$.extend)return(t=this$.csscopes).global=t.global.concat(this$.extend.csscopes.global||[]),!0===this$.extendStyle?(t=this$.csscopes).local=t.local.concat(this$.extend.csscopes.local||[]):"overwrite"===this$.extendDom?(t=this$.csscopes).local=t.local.concat(this$.extend.csscopes.local.slice(1)):void 0}).catch(function(e){var t;return console.error("[@plotdb/block] init block {name: "+this$.name+", version: "+this$.version+", path: "+(this$.path||"")+"}",e),t=doc.createElement("div"),t.innerText="failed",this$.interface={},this$.styleNode={},this$.factory=function(){return this},this$.dependencies=[],this$})},context:function(){return this._ctx},dom:function(){return this.node},i18n:function(e){var t;return t=this.id,block.i18n.module.t([t+":"+e].concat(this.extends.map(function(t){return t.id+":"+e}),[e]))},create:function(e){var t=this;return null==e&&(e={}),this.init().then(function(){var n;return(n=new block.instance({block:t,name:t.name,version:t.version,data:e.data})).init().then(function(){return n})})},resolvePlugAndCloneNode:function(e,t){var n;return null==t&&(t=!1),t?n=e:(n=this.dom().cloneNode(!0),e&&Array.from(n.querySelectorAll("plug")).map(function(t){var n,i;if(n=t.getAttribute("name"),i=e.querySelector(":scope :not([plug]) [plug="+n+"], :scope > [plug="+n+"]"))return t.replaceWith(i)})),this.extend&&!1!==this.extendDom?"overwrite"===this.extendDom?this.extend.resolvePlugAndCloneNode(n,!0):this.extend.resolvePlugAndCloneNode(n):n}}),block.instance=function(e){var t=this;return null==e&&(e={}),this.name=e.name,this.version=e.version,this.block=e.block,this.data=e.data,this.init=proxise.once(function(){return t._init()}),this},block.instance.prototype=import$(Object.create(Object.prototype),{_init:function(){return this.block.init()},attach:function(e){var t,n,i,r,o,s,c,l;if(null==e&&(e={}),e.data&&(this.data=e.data),t=e.root,t=t?"string"==typeof t?doc.querySelector(t):t:null,block.global.csscope.apply(this.block.csscopes.global),t){for(n=this.dom(),i=[this.block].concat(this.block.extends),r=[this.block.scope],o=0,s=i.length-1;o<s;++o)if(c=o,"overwrite"!==(l=i[c].extendStyle)){if(!1===l)break;r.push(i[c+1].scope)}n.setAttribute("scope",r.join(" ")),n.classList.add.apply(n.classList,this.block.csscopes.local.map(function(e){return e.scope}).concat(this.block.csscopes.global.map(function(e){return e.scope}))),e.before&&t.insertBefore(n,e.before),t.appendChild(n)}else n=null;return this.run({node:n,type:"init"})},detach:function(){var e;return(e=this.dom()).parentNode.removeChild(e),this.run({node:e,type:"destroy"})},interface:function(){var e,t,n;for(e=this.obj.length;e>=0;--e)if(t=e,n=(this.obj[t]||{}).interface)return n instanceof Function?n.apply(this.obj[t]):n;return null},update:function(e){return this.datadom.update(e)},_transform:function(e){var t,n=this;return t=function(e){var i,r,o,s,c,l,u,a,h=[];if(e.nodeType===win.Element.TEXT_NODE)return e.parentNode.replaceChild(doc.createTextNode(n.i18n(e.textContent)),e);for(i=0,r=e.attributes.length;i<r;++i)o=i,c=(s=e.attributes[o]).name,l=s.value,(u=/^t-(.+)$/.exec(c))&&e.setAttribute(u[1],n.i18n(l||""));if(a=e.getAttribute("t"))return e.textContent=n.i18n(a);for(i=0,r=e.childNodes.length;i<r;++i)o=i,h.push(t(e.childNodes[o]));return h},Array.from(e.querySelectorAll("[t]")).filter(function(e){return e.hasAttribute("t")}).map(function(e){return t(e)}),e},dom:function(){var e;return(e=this.node)?e:(this.node=this.block.resolvePlugAndCloneNode(),this._transform(this.node))},i18n:function(e){return this.block.i18n(e)},run:function(e){var t,n,i,r,o,s=this;for(t=e.node,n=e.type,i=[],r=[],o=this.block,this.obj||(this.obj=[]),this.pubsub||(this.pubsub=new pubsub);o;)i=[o].concat(i),o=o.extend;return new Promise(function(e,o){var c;return(c=function(i,l,u,a){var h,p;return null==i&&(i=[]),null==l&&(l=0),null==u&&(u={}),i.length<=l?Promise.all(r).then(function(t){return e(t)}).catch(function(e){return o(e)}):(h=i[l],function(e){var o,p;return import$(u,e),o={root:t,parent:a,ctx:u,context:u,pubsub:s.pubsub,i18n:{addResourceBundles:function(e){var t,n,i=[];null==e&&(e={});for(t in e)n=e[t],i.push(block.i18n.addResourceBundle(t,s.block.id,n));return i},t:function(e){return s.block.i18n(e)}},t:function(e){return s.block.i18n(e)},data:s.data},"init"===n&&s.obj.push(p=new h.factory(o)),r.push((p=s.obj[l])?s.obj[l][n](o):null),c(i,l+1,u,p)}(h._ctx.ctx?h._ctx.ctx():(p=h._ctx).local||(p.local={})))})(i,0,{})})}}),block.env("undefined"!=typeof self&&null!==self?self:globalThis),"undefined"!=typeof module&&null!==module?module.exports=block:"undefined"!=typeof window&&null!==window&&(window.block=block)}).call(this);
