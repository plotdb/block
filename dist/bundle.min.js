!function(){block.manager.prototype.bundle=function(opt){var mgr,hash,_;return null==opt&&(opt={}),mgr=opt.manager||this,hash={},_=function(list,blocks,deps){var bd,id;return(null==blocks&&(blocks=[]),null==deps&&(deps={js:[],css:[]}),list.length)?(bd=list.splice(0,1)[0],id=block.id(bd),hash[id]?Promise.resolve().then(function(){return _(list,blocks,deps)}):_fetch(mgr.getUrl(bd),{method:"GET"}).then(function(it){var node,ref$,js,css,ret,b,node=doc.createElement("div");return node.innerHTML=it,1<node.childNodes.length&&console.warn("DOM definition of a block should contain only one root."),ref$=["script","style"].map(function(e){return Array.from(node.querySelectorAll(e)).map(function(e){return e.parentNode.removeChild(e),e.textContent}).join("\n")}),js=ref$[0],css=ref$[1],node.childNodes[0].setAttribute("block",id),ret=eval("(function(module){"+(js||"")+";return module.exports;})({})"),ret instanceof Function&&(ret=ret()),ret=ret||{},ret.pkg||(ret.pkg={}),(ref$=ret.pkg).dependencies||(ref$.dependencies=[]),ret.pkg.extend&&(ret.pkg.extend.name||(ref$=ret.pkg.extend,ref$.name=bd.name,ref$.version=bd.version),list.push(ret.pkg.extend)),ret.pkg.dependencies.map(function(e){if(e.name||(e.name=bd.name,e.version=bd.version),!e.type)return!/\.js$/.exec(e.url||e.path||e)&&/\.css$/.exec(e.url||e.path||e)?e.type="css":e.type="js"}),deps.js=deps.js.concat((ret.pkg.dependencies||[]).filter(function(e){return"js"===e.type||/\.js/.exec(e.path||e||"")})),deps.css=deps.css.concat((ret.pkg.dependencies||[]).filter(function(e){return"css"===e.type||/\.css/.exec(e.path||e||"")})),js="((function(module){"+(js||"")+";return module.exports;})({}))",blocks.push(b={js:js,css:css,html:node.innerHTML,bd:bd,id:id}),hash[id]=b,_(list,blocks,deps)})):Promise.resolve({blocks:blocks,deps:deps})},_(opt.blocks||(opt.blocks=[])).then(function(e){var o=e.blocks,c=e.deps;return Promise.all([mgr.csscope.bundle(c.css),mgr.rescope.bundle(c.js)]).then(function(e){var t,n,s=e[0],e=e[1],r=o.map(function(e){return'"'+e.id+'":'+(e.js||'""')});return r="document.currentScript.import({"+r.join(",\n")+"});",t=c.css.map(function(e){return"csscope.cache("+JSON.stringify((e.inited=!0,e.scope=csscope.scope(e),e))+")"}).join(";"),n=o.map(function(e){var t=csscope.scope(e);return csscope({rule:"*[scope~="+t+"]",name:t,css:e.css||"",scopeTest:"[scope]"})}).join("\n"),"<template>\n  "+o.map(function(e){return e.html||""}).join("\n")+'\n  <style type="text/css">'+n+s+'</style>\n  <script type="text/javascript">'+r+e+";"+t+"<\/script>\n</template>"})})}}.call(this);
