var lc,wrap,serialize,deserialize,locate,update,opt,je,b,nt,nt2,ops,opsIn;lc={json:{}},Array.from(document.querySelectorAll("button")).map(function(e){return e.addEventListener("click",function(){return alert("ok")})}),wrap=function(e){var t,n,r,o,u,i;return"#text"===(t=e.nodeName.toLowerCase())?{type:"text",value:e.nodeValue}:(n=e.style?function(){var t,n,o=[];for(t=0,n=e.style.length;t<n;++t)r=t,o.push(r);return o}().map(function(t){return[e.style[t],e.style[e.style[t]]]}):[],o=e.attributes?function(){var t,n,r,o=[];for(t=0,r=(n=e.attributes).length;t<r;++t)u=n[t],o.push([u.nodeName,u.nodeValue]);return o}().filter(function(e){var t;return!("style"===(t=e[0])||"class"===t)}):[],i=e.classList?function(){var t,n,r,o=[];for(t=0,r=(n=e.classList).length;t<r;++t)u=n[t],o.push(u);return o}():[],{type:"tag",name:t,style:n,attr:o,cls:i})},serialize=function(e){var t,n,r,o,u,i;if(t=wrap(e),n=[],e.childNodes){for(r=0,o=e.childNodes.length;r<o;++r)u=r,i=serialize(e.childNodes[u]),n.push(i);return t.child=n,t}},deserialize=function(e){var t;return t=[],Promise.resolve().then(function(){var n;return(n=function(e){var r,o,u,i,l;if("text"===e.type)return document.createTextNode(e.value);if("block"===e.type)return function(){var n;return n=document.createElement("div"),n.textContent="loading...",t.push(debounce(2e3).then(function(){return blockManager.get({name:e.name,version:e.version})}).then(function(e){return e.instantiate().then(function(e){var t,r;return(t=n.parentNode)?((r=t).insertBefore(e.node,n),r.removeChild(n),r):e})}).catch(function(){return console.log("block-manager.get failed in deserialize ( "+e.name+"@"+e.version+" )"),n.innerText="load fail."})),n}();for(r=document.createElement(e.name),e.attr.filter(function(e){return e&&e[0]}).map(function(e){return r.setAttribute(e[0],e[1])}),e.style.filter(function(e){return e&&e[0]}).map(function(e){return r.style[e[0]]=e[1]}),e.cls&&e.cls.length&&r.classList.add.apply(r.classList,e.cls.filter(function(e){return e})),o=0,i=(u=e.child||[]).length;o<i;++o)(l=n(u[o]))&&r.appendChild(l);return r})(e)}).then(function(e){return{node:e,promise:Promise.all(t)}})},locate=function(e,t,n){var r,o,u,i,l,a,s;for(r=n,o=t,console.log(e.p,e),u=e.p.length-1;u>=0&&(i=u,"attr"!==(l=e.p[i])&&"style"!==l&&"cls"!==l&&"child"!==l&&"name"!==l&&"value"!==l&&"type"!==l);--u);for(u=0,a=i-1;u<a;++u)u,s=e.p[i],r="child"===s?r.childNodes:r,o=o[s];switch(console.log(e.p[i],e.p[i+1],i),e.p[i]){case"name":case"value":case"type":return deserialize(o).then(function(e){var t;return t=e.node,e.promise,r.parentNode.insertBefore(t,r),r.parentNode.removeChild(r)});case"style":return r.setAttribute("style",""),o.style.map(function(e){return r.style[e[0]]=e[1]});case"cls":return r.setAttribute("class",o.cls.join(" "));case"attr":return Array.from(r.attributes).map(function(e){var t;if(!o.attr[e.name]&&"block"!==(t=e.name)&&"style"!==t&&"class"!==t)return r.removeAttribute(e.name)}),o.attr.map(function(e){return r.setAttribute(e[0],e[1])});case"child":if(e.ld&&(console.log(e.ld,i),r.removeChild(r.childNodes[e.p[i+1]])),e.li)return deserialize(e.li).then(function(t){var n;return n=t.node,t.promise,r.insertBefore(n,r.childNodes[e.p[i+1]])})}},update=function(e){return null==e&&(e=[]),e.length?e.map(function(e){return locate(e,lc.json,out.childNodes[0])}):deserialize(lc.json).then(function(e){var t;return t=e.node,e.promise,out.innerHTML="",out.appendChild(t)})},opt={onChange:function(){var e,t;return e=je.get(),t=json0OtDiff(lc.json,e),sharedb.types.defaultType.apply(lc.json,t),update(t)}},je=new JSONEditor(editor,opt),b=new block({name:"two-button",root:ld$.find("[block]",0)}),blockManager.add({name:"two-button",version:"0.0.1",block:b}),lc.json=nt=JSON.parse(JSON.stringify(b.tree)),nt2=JSON.parse(JSON.stringify(b.tree)),ops=[{p:["child",4],li:{type:"block",name:"two-button",version:"0.0.1"}},{p:["child",5],li:{type:"block",name:"sample",version:"0.0.1"}},{p:["style",0],li:["background","yellow"]},{p:["cls",0],li:"text-danger"},{p:["attr",0],li:["data-name","blah"]},{p:["attr",0],ld:["data-name","blah"]},{p:["child",5],ld:{type:"block",name:"sample",version:"0.0.1"}}],je.set(lc.json),update(),opsIn=function(e,t){return null==t&&(t=!0),sharedb.types.defaultType.apply(lc.json,e),je.set(lc.json),update(e)},debounce(1e3).then(function(){return opsIn([ops[0]])}).then(function(){return ld$.find("button").map(function(e){return e.addEventListener("click",function(){return alert("ok")})})}).then(function(){return debounce(1e3)}).then(function(){return opsIn([ops[1]])}).then(function(){return debounce(1e3)}).then(function(){return opsIn([ops[2]])}).then(function(){return debounce(1e3)}).then(function(){return opsIn([ops[3]])}).then(function(){return debounce(1e3)}).then(function(){return opsIn([ops[4]])}).then(function(){return debounce(1e3)}).then(function(){return opsIn([ops[5]])}).then(function(){return debounce(1e3)}).then(function(){return opsIn([ops[6]])}).then(function(){return debounce(1e3)});